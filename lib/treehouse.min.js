var ge=Object.defineProperty;var He=Object.getOwnPropertyDescriptor;var a=(r,e)=>ge(r,"name",{value:e,configurable:!0});var S=(r,e,n,t)=>{for(var o=t>1?void 0:t?He(e,n):e,i=r.length-1,s;i>=0;i--)(s=r[i])&&(o=(t?s(e,n,o):s(o))||o);return t&&o&&ge(e,n,o),o};var we=navigator.userAgent.toLowerCase().indexOf("mac")!==-1;function ie(r){if(!r)return[];let e={backspace:"\u232B",shift:"\u21E7",meta:"\u2318",tab:"\u21B9",ctrl:"\u2303",arrowup:"\u2191",arrowdown:"\u2193",arrowleft:"\u2190",arrowright:"\u2192",enter:"\u23CE"};return r.toLowerCase().split("+").map(ve).map(t=>Object.keys(e).includes(t)?e[t]:t)}a(ie,"bindingSymbols");function ve(r){return!we&&r==="meta"?"ctrl":r}a(ve,"filterKeyForNonMacMeta");var Z=class{constructor(){this.bindings=[]}registerBinding(e){this.bindings.push(e)}getBinding(e){for(let n of this.bindings)if(n.command===e)return n;return null}evaluateEvent(e){e:for(let n of this.bindings){let t=n.key.toLowerCase().split("+");if(t.pop()===e.key.toLowerCase()){for(let i of["shift","ctrl","alt","meta"]){let s=t.includes(i);if(!we){if(i==="meta")continue;i==="ctrl"&&(s=t.includes("meta")||t.includes("ctrl"))}let l=e[`${ve(i)}Key`];if(!l&&s||l&&!s)continue e}return n}}return null}};a(Z,"KeyBindings");var ee=class{constructor(){this.commands={}}registerCommand(e){this.commands[e.id]=e}canExecuteCommand(e,...n){return this.commands[e]?!(this.commands[e].when&&!this.commands[e].when(...n)):!1}executeCommand(e,...n){return new Promise(t=>{let o=this.commands[e].action(...n);t(o)})}};a(ee,"CommandRegistry");var te=class{constructor(){this.menus={}}registerMenu(e,n){this.menus[e]=n}};a(te,"MenuRegistry");function ye(r,e,n,t){return n?e.disabled||!r.canExecuteCommand(n.id,t):e.disabled}a(ye,"isDisabled");var ke={view({attrs:{workbench:r,x:e,y:n,items:t,align:o,commands:i,ctx:s}}){let l=a((d,c)=>p=>{p.stopPropagation(),!ye(r,d,c,s)&&(r.closeMenu(),d.onclick&&d.onclick(),c&&r.executeCommand(c.id,s))},"onclick");return m("ul",{class:"menu",style:{margin:"0",display:"inline-block"}},t.filter(d=>!d.when||d.when()).map(d=>{let c="",p,f;return d.command&&(f=i.find(v=>v.id===d.command),p=r.keybindings.getBinding(f.id),c=f.title),d.title&&(c=d.title()),m("li",{onclick:l(d,f),class:ye(r,d,f,s)?"disabled":"",style:{display:"flex"}},m("div",null,c),p&&m("div",{class:"keybindings grow text-right"},ie(p.key).join(" ").toUpperCase()))}))}};var J={onupdate({state:r,dom:e}){let n=e.querySelector(".items").children;r.selected!==void 0&&n.length>0&&n[r.selected].scrollIntoView({block:"nearest"})},oncreate({attrs:r,state:e,dom:n}){r.inputview&&n.querySelector("input")?.focus(),e.selected===void 0&&(e.selected=0)},view({attrs:r,state:e}){e.selected=e.selected===void 0?0:e.selected,e.input=e.input===void 0?r.input||"":e.input,e.items===void 0&&(e.items=[],r.onchange(e));let n=a(o=>{let i=a((s,l)=>(s%l+l)%l,"mod");if(o.key==="ArrowDown")return e.selected===void 0?(e.selected=0,!1):(e.selected=i(e.selected+1,e.items.length),!1);if(o.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=i(e.selected-1,e.items.length),!1;if(o.key==="Enter")return e.selected!==void 0&&r.onpick(e.items[e.selected]),!1},"onkeydown"),t=a(o=>{e.input=o.target.value,e.selected=0,r.onchange(e)},"oninput");return m("div",{class:"picker"},r.inputview(n,t,e.input),m("div",{class:"items"},e.items.map((o,i)=>m("div",{class:e.selected===i?"item selected":"item",onclick:()=>r.onpick(o),onmouseover:()=>e.selected=i},r.itemview(o,i)))))}};var be={view({attrs:{workbench:r,ctx:e}}){let n=a(d=>(d.title||d.id).replace("-"," ").replace(/(^|\s)\S/g,p=>p.toUpperCase()),"getTitle"),t=a((d,c)=>n(d).localeCompare(n(c)),"sort"),o=a(d=>{r.closeDialog(),r.commands.executeCommand(d.id,e)},"onpick"),i=a(d=>{d.items=l.filter(c=>(c.title||c.id).toLowerCase().includes(d.input.toLowerCase()))},"onchange"),s=a(d=>{let c=r.keybindings.getBinding(d.id);return c?ie(c.key).join(" ").toUpperCase():""},"getBindingSymbols"),l=Object.values(r.commands.commands).filter(d=>!d.hidden).sort(t);return m("div",{class:"palette"},m(J,{onpick:o,onchange:i,inputview:(d,c)=>m("div",null,m("input",{style:{width:"98%"},type:"text",onkeydown:d,oninput:c,placeholder:"Enter command..."})),itemview:d=>m("div",{class:"flex"},m("div",null,n(d)),m("div",{class:"keybindings grow text-right"},s(d)))}))}};function z(r,e){return r.value&&r.value[e]instanceof Function}a(z,"hasHook");function V(r,e,...n){if(z(r,e))return r.value[e].apply(r.value,n)}a(V,"triggerHook");function W(r,e){for(let n of r.components)if(z(n,e))return!0;return!1}a(W,"objectHas");function ne(r,e,...n){for(let t of r.components)if(z(t,e))return t.value[e].apply(t.value,n)}a(ne,"objectCall");function re(r,e,...n){let t=[];for(let o of r.components)z(o,e)&&t.push(o.value);return t}a(re,"componentsWith");function O(r){return W(r,"objectChildren")}a(O,"objectManaged");var pe={};function I(r){pe[Q(r)]=r}a(I,"component");function Q(r){return r.prototype===void 0&&(r=r.constructor),`treehouse.${r.name}`}a(Q,"componentName");function K(r){return typeof r=="string"?pe[r]:pe[Q(r)]}a(K,"getComponent");function xe(r,e){let n=new(K(r));return n.fromJSON instanceof Function?n.fromJSON(e):Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)),n}a(xe,"inflateToComponent");function Ce(r){if(r===void 0)return;if(!K(r))return structuredClone(r);let n=JSON.parse(JSON.stringify(r)||""),t=new r.constructor;return t.fromJSON instanceof Function?t.fromJSON(n):Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)),t}a(Ce,"duplicate");var R=class{constructor(){}onAttach(e){this.object=e.parent,this.object.setAttr("view","document")}handleIcon(e=!1){return m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"15",height:"15",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"node-bullet"},m("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),m("polyline",{points:"14 2 14 8 20 8"}),m("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),m("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),m("polyline",{points:"10 9 9 9 8 9"}))}toJSON(e){return{}}static initialize(e){e.commands.registerCommand({id:"make-document",title:"Make Document",action:n=>{if(!n.node)return;let t=new R;n.node.addComponent(t),n.node.changed(),e.executeCommand("zoom",n)}})}};a(R,"Document"),R=S([I],R);var q={view({attrs:{workbench:r,path:e,onkeydown:n,oninput:t,disallowEmpty:o,editValue:i,placeholder:s},state:l}){let d=e.node,c=i?"value":"name",p=a(()=>c==="name"?W(d,"displayName")?ne(d,"displayName",d):d.name:d[c]||"","display"),f=a(()=>{l.initialValue=d[c],r.context.node=d,r.context.path=e},"onfocus"),v=a(()=>d[c],"getter"),b=a((g,y)=>{d.isDestroyed||(o&&g.length===0?d[c]=l.initialValue:d[c]=g),y&&(r.context.node=null)},"setter");d.raw.Rel==="Fields"&&(s=i?"Value":"Field");let w=`input-${e.id}-${d.id}`;c==="value"&&(w=w+"-value");let h=We;return d.parent.hasComponent(R)&&window.Editor&&(h=$e),m(h,{id:w,getter:v,setter:b,display:p,onkeydown:n,onfocus:f,oninput:t,placeholder:s})}},$e={oncreate({dom:r,state:e,attrs:{id:n,onkeydown:t,onfocus:o,onblur:i,oninput:s,getter:l,setter:d,display:c,placeholder:p}}){let f=e.editing?e.buffer:c?c():l(),v=a(g=>{g.key==="Enter"&&(g.preventDefault(),g.stopPropagation())},"defaultKeydown"),b=a(g=>{o&&o(g),e.editing=!0,e.buffer=l()},"startEdit"),w=a(g=>{e.editing&&(e.editing=!1,d(e.buffer,!0),e.buffer=void 0),i&&i(g)},"finishEdit"),h=a(g=>{e.buffer=g.target.value,d(e.buffer,!1),s&&s(g)},"edit");e.editor=new window.Editor(r,f,p),e.editor.onblur=w,e.editor.onfocus=b,e.editor.oninput=h,e.editor.onkeydown=t||v,r.editor=e.editor,r.id=n},onupdate({dom:r,state:e,attrs:{getter:n,display:t}}){e.editor.value=e.editing?e.buffer:t?t():n()},view(){return m("div",{class:"text-editor"})}},We={oncreate({dom:r,attrs:e}){let n=r.querySelector("textarea"),t=n.offsetHeight,o=r.querySelector("span");this.updateHeight=()=>{o.style.width=`${Math.max(n.offsetWidth,100)}px`,o.innerHTML=n.value.replace(`
`,"<br/>"),n.style.height=o.offsetHeight>0?`${o.offsetHeight}px`:`${t}px`},n.addEventListener("input",()=>this.updateHeight()),n.addEventListener("blur",()=>o.innerHTML=""),setTimeout(()=>this.updateHeight(),50),e.onmount&&e.onmount(n)},onupdate(){this.updateHeight()},view({attrs:{id:r,onkeydown:e,onfocus:n,onblur:t,oninput:o,getter:i,setter:s,display:l,placeholder:d},state:c}){let p=c.editing?c.buffer:l?l():i();return m("div",{class:"text-editor"},m("textarea",{id:r,rows:"1",onfocus:a(h=>{n&&n(h),c.editing=!0,c.buffer=i()},"startEdit"),onblur:a(h=>{c.editing&&(c.editing=!1,s(c.buffer,!0),c.buffer=void 0),t&&t(h)},"finishEdit"),oninput:a(h=>{c.buffer=h.target.value,s(c.buffer,!1),o&&o(h)},"edit"),placeholder:d,onkeydown:e||a(h=>{h.key==="Enter"&&(h.preventDefault(),h.stopPropagation())},"defaultKeydown"),value:p},p),m("span",{style:{visibility:"hidden",position:"fixed"}}))}};var Ne={view({attrs:{node:r,workbench:e,panel:n}}){return m("div",{class:"empty-view"})}};var se={view({attrs:{workbench:r,path:e}}){return m("div",{class:"new-node flex flex-row items-center"},m("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7"}),m("path",{style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{class:"flex grow"},m("input",{class:"grow",type:"text",oninput:a(o=>{r.executeCommand("insert-child",{node:e.node,path:e},o.target.value)},"startNew"),onkeydown:a(o=>{if(o.key==="Tab"&&(o.stopPropagation(),o.preventDefault(),node.childCount>0)){let i=e.node.children[e.node.childCount-1];r.executeCommand("insert-child",{node:i,path:e})}},"tabNew"),value:""})))}};function qe(r,e=1e3){let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>{r.apply(this,t)},e)}}a(qe,"debounce");var H=class{constructor(){this.workbench=window.workbench,this.searchDebounce=qe(this.search.bind(this)),this.query="",this.initialSearch=!1}handleIcon(e=!1){return m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",class:"node-bullet",width:"15",height:"15",fill:"none",stroke:"currentColor","stroke-width":"3","stroke-linecap":"round","stroke-linejoin":"round"},e?m("circle",{id:"node-collapsed-handle",stroke:"none",cx:"12",cy:"12",r:"12"}):null,m("svg",{xmlns:"http://www.w3.org/2000/svg",x:"3",y:"3",width:"19",height:"19",viewBox:"0 0 24 24"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})))}belowEditor(){return Ue}onAttach(e){this.component=e,this.object=e.parent,e.bus.observe(n=>{e.isDestroyed||this.searchDebounce()})}search(){if(!this.object)return;if(!this.query){this.lastQuery="",this.results=[];return}this.initialSearch=!0;let e=this.workbench.search(this.query).filter(n=>n.id!==this.object.id&&n.id!==this.component.id);(e.length!==this.lastResultCount||this.query!==this.lastQuery)&&(this.results&&this.results.forEach(n=>n.destroy()),this.results=e.map(n=>{let t=this.object.bus.make("");return t.raw.Parent="@tmp",t.refTo=n,t}),this.lastQuery=this.query,this.lastResultCount=e.length)}objectChildren(e,n){return!this.results&&this.query&&!this.initialSearch&&this.search(),this.results||[]}toJSON(e){return{query:this.query}}fromJSON(e){this.query=e.query||""}static initialize(e){e.commands.registerCommand({id:"make-smart-node",title:"Make Smart Node",action:n=>{if(!n.node||n.node.childCount>0)return;e.defocus();let t=new H;n.node.addComponent(t),e.workspace.setExpanded(n.path.head,n.node,!0),n.node.name===""&&setTimeout(()=>{n.node.name="Unnamed Smart Node",m.redraw(),document.querySelector(`#node-${n.path.id}-${n.node.id} input`).focus()},10)}})}};a(H,"SmartNode"),H=S([I],H);var Ue={view({attrs:{node:r,component:e,expanded:n}}){if(!n)return;let t=a(o=>{e.query=o.target.value,e.search(),r.changed()},"oninput");return m("div",{class:"expanded-node flex flex-row"},m("div",{class:"indent flex"}),m("input",{type:"text",class:"grow",placeholder:"Enter search",value:e.query,oninput:t,style:{background:"inherit",border:"1px solid var(--color-outline-secondary)",outline:"0",padding:"var(--1)",marginBottom:"var(--1)",borderRadius:"var(--border-radius)"}}))}};var Se={view({attrs:{workbench:r,path:e,alwaysShowNew:n}}){let t=e.node;e.node.refTo&&(t=e.node.refTo);let o=!1;return(t.childCount===0&&t.getLinked("Fields").length===0||n)&&(o=!0),t.hasComponent(H)&&(o=!1),m("div",{class:"list-view"},m("div",{class:"fields"},t.getLinked("Fields").length>0&&t.getLinked("Fields").map(i=>m($,{key:i.id,workbench:r,path:e.append(i)}))),m("div",{class:"children"},t.childCount>0&&t.children.map(i=>m($,{key:i.id,workbench:r,path:e.append(i)})),o&&m(se,{workbench:r,path:e})))}};var Ie={view({attrs:{workbench:r,path:e},state:n}){let t=e.node;n.fields=n.fields===void 0?new Set:n.fields,t.children.forEach(i=>{i.getLinked("Fields").forEach(s=>n.fields.add(s.name))});let o=a((i,s)=>{let l=i.getLinked("Fields").filter(d=>d.name===s);return l.length===0?"":m(q,{editValue:!0,workbench:r,path:e.append(l[0])})},"getFieldEditor");return m("table",{class:"table-view",style:{gridTemplateColumns:`repeat(${n.fields.size+1}, 1fr)`}},m("thead",null,m("tr",null,m("th",null,"Title"),[...n.fields].map(i=>m("th",null,i)))),m("tbody",null,t.children.map(i=>m("tr",null,m("td",null,m($,{key:i.id,workbench:r,path:e.append(i)})),[...n.fields].map(s=>m("td",null,o(i,s)))))))}};var De={view({attrs:{workbench:r,path:e},state:n}){let t=e.node;n.tabs=n.tabs===void 0?new Set:n.tabs,n.selectedTab=n.selectedTab===void 0?"":n.selectedTab,t.children.forEach(i=>{n.tabs.add(i.raw),n.selectedTab===""&&(n.selectedTab=i.raw.ID)});let o=a(i=>{n.selectedTab=i},"handleTabClick");return m("div",{class:"tabs-view"},m("div",{class:"tabs"},[...n.tabs].map(i=>m("div",{class:i.ID===n.selectedTab?"active":"",onclick:()=>o(i.ID)},i.Name)),m("div",{style:{flexGrow:1}})),m("div",{class:"tab-content"},t.children.filter(i=>i.id===n.selectedTab).map(i=>(e=e.append(i),i.children.map(s=>m($,{key:s.id,workbench:r,path:e.append(s)}))))))}};var Le={view({attrs:{workbench:r,path:e,alwaysShowNew:n}}){let t=e.node;e.node.refTo&&(t=e.node.refTo);let o=!1;return(t.childCount===0&&t.getLinked("Fields").length===0||n)&&(o=!0),m("div",{class:"document-view"},m("div",{class:"fields"},t.getLinked("Fields").length>0&&t.getLinked("Fields").map(i=>m($,{key:i.id,workbench:r,path:e.append(i)}))),m("div",{class:"children"},t.childCount>0&&t.children.map(i=>m($,{key:i.id,workbench:r,path:e.append(i)})),o&&m(se,{workbench:r,path:e})))}};var Ee={list:Se,table:Ie,tabs:De,document:Le};function he(r){return Ee[r]||Ne}a(he,"getView");window.registerView=(r,e)=>{Ee[r]=e,workbench.commands.registerCommand({id:`view-${r}`,title:`View as ${ze(r)}`,action:n=>{n.node&&n.node.setAttr("view",r)}})};function ze(r){return r.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}a(ze,"toTitleCase");var M=class{constructor(){}onAttach(e){this.object=e.parent}handleIcon(e=!1){return m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"15",height:"15",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"3","stroke-linecap":"round","stroke-linejoin":"round",class:"node-bullet"},e?m("circle",{id:"node-collapsed-handle",stroke:"none",cx:"12",cy:"12",r:"12"}):null,m("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),m("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"}))}toJSON(e){return{}}static initialize(e){e.commands.registerCommand({id:"make-template",title:"Make Template",action:n=>{if(!n.node)return;let t=new M;n.node.addComponent(t),n.node.changed()}})}static findNode(e,n){let t=null;return e.mainNode().walk(o=>o.value instanceof M&&o.value.object.name===n?(t=o.value.object,!0):!1,{includeComponents:!0}),t}};a(M,"Template"),M=S([I],M);var D=class{constructor(e){this.name=e}afterEditor(){return Ve}static initialize(e){e.commands.registerCommand({id:"add-tag",title:"Add tag",hidden:!0,action:(n,t)=>{if(!n.node)return;let o=new D(t);n.node.addComponent(o);let i=M.findNode(e.workspace,t);i&&(i.fields.map(s=>s.duplicate()).forEach(s=>{n.node.addLinked("Fields",s),s.raw.Parent=n.node.raw.ID}),i.children.map(s=>s.duplicate()).forEach(s=>{n.node.addChild(s),s.raw.Parent=n.node.raw.ID})),n.node.changed()}})}static findAll(e){let n=new Set;return e.mainNode().walk(t=>(t.value instanceof D&&n.add(t.value.name),!1),{includeComponents:!0}),[...n]}static findTagged(e,n){let t=[];return e.mainNode().walk(o=>(o.value instanceof D&&o.value.name===n&&t.push(o.parent),!1),{includeComponents:!0}),t}static showPopover(e,n,t,o,i){let s=D.findAll(e.workspace),l=e.getInput(n),d=l.getBoundingClientRect(),c=document.body.scrollLeft+d.x+l.selectionStart*10+20,p=document.body.scrollTop+d.y+d.height;e.showPopover(()=>m(J,{onpick:f=>{i(),e.getInput(n).blur(),t.name=t.name.replace(/\s*#\w*/,""),e.executeCommand("add-tag",{node:t,path:n},f.name)},onchange:f=>{t.name.includes("#")?f.input=t.name.split("#")[1]:f.input="";let v=[...s].filter(b=>b.toLowerCase().startsWith(f.input.toLowerCase())).map(b=>({name:b}));(v[0]&&v[0].name!=f.input&&f.input!=""||v.length===0)&&v.unshift({name:f.input,prefix:"Create tag: "}),f.items=v},inputview:o,itemview:f=>m("div",{class:"flex"},m("div",null,f.prefix||"",f.name))}),{top:`${p}px`,left:`${c}px`})}};a(D,"Tag"),D=S([I],D);var Ve={view({attrs:{node:r,component:e}}){return m("div",{tabindex:"1",class:"badge flex flex-row items-center",onkeydown:a(t=>{t.key==="Backspace"&&(r.removeComponent(e),r.changed())},"onkeydown")},m("span",null,"#\xA0"),m("div",{style:{whiteSpace:"nowrap"}},e.name))}};var ae={view({attrs:{workbench:r,path:e,alwaysShowNew:n}}){return m(he(e.node.getAttr("view")||"list"),{workbench:r,path:e,alwaysShowNew:n})}},$={view({attrs:r,state:e,children:n}){let{path:t,workbench:o}=r,i=t.node,s=!1,l=i;i.refTo&&(s=!0,i=l.refTo);let d=o.workspace.getExpanded(t.head,l),c=W(i,"handlePlaceholder")?ne(i,"handlePlaceholder"):"",p=a(u=>{e.hover=!0,u.stopPropagation()},"hover"),f=a(u=>{e.hover=!1,u.stopPropagation()},"unhover"),v=a(()=>{e.tagPopover&&(o.closePopover(),e.tagPopover=void 0)},"cancelTagPopover"),b=a(u=>{e.tagPopover?(e.tagPopover.oninput(u),u.target.value.includes("#")||v()):u.target.value.includes("#")&&(e.tagPopover={},D.showPopover(o,t,i,(B,x)=>{e.tagPopover={onkeydown:B,oninput:x}},v))},"oninput"),w=a(u=>{if(e.tagPopover){if(u.key==="Escape"){v();return}if(e.tagPopover.onkeydown(u)===!1)return u.stopPropagation(),!1}let B=u.shiftKey||u.metaKey||u.altKey||u.ctrlKey;switch(u.key){case"ArrowUp":u.target.selectionStart!==0&&!B&&u.stopPropagation();break;case"ArrowDown":u.target.selectionStart!==u.target.value.length&&u.target.selectionStart!==0&&!B&&u.stopPropagation();break;case"Backspace":if(u.target.value===""){if(u.preventDefault(),u.stopPropagation(),i.childCount>0)return;o.executeCommand("delete",{node:i,path:t,event:u});return}if(u.target.value!==""&&u.target.selectionStart===0&&u.target.selectionEnd===0){if(u.preventDefault(),u.stopPropagation(),i.childCount>0)return;let x=o.workspace.findAbove(t);if(!x)return;let E=x.node.name;x.node.name=E+u.target.value,i.destroy(),m.redraw.sync(),o.focus(x,E.length);return}break;case"Enter":if(u.preventDefault(),u.ctrlKey||u.shiftKey||u.metaKey||u.altKey)return;if(u.target.selectionStart===u.target.value.length){i.childCount>0&&o.workspace.getExpanded(t.head,i)?o.executeCommand("insert-child",{node:i,path:t},"",0):o.executeCommand("insert",{node:i,path:t}),u.stopPropagation();return}if(u.target.selectionStart===0){o.executeCommand("insert-before",{node:i,path:t}),u.stopPropagation();return}if(u.target.selectionStart>0&&u.target.selectionStart<u.target.value.length){o.executeCommand("insert",{node:i,path:t},u.target.value.slice(u.target.selectionStart)).then(()=>{i.name=u.target.value.slice(0,u.target.selectionStart)}),u.stopPropagation();return}break}},"onkeydown"),h=a(u=>{u.preventDefault(),u.stopPropagation(),o.executeCommand("zoom",{node:i,path:t}),document.selection&&document.selection.empty?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()},"open"),g=a(u=>{if(i.hasComponent(R)){h(u);return}d?o.executeCommand("collapse",{node:l,path:t}):o.executeCommand("expand",{node:l,path:t}),u.stopPropagation()},"toggle"),y=a(u=>u.childCount+u.getLinked("Fields").length,"subCount"),j=a(()=>{if(i.id===o.context?.node?.id||e.hover||i.name.length>0||c.length>0)return!0},"showHandle");return m("div",{onmouseover:p,onmouseout:f,id:`node-${t.id}-${l.id}`},m("div",{class:"node-row-outer-wrapper flex flex-row items-start"},m("svg",{class:"node-menu shrink-0",xmlns:"http://www.w3.org/2000/svg",onclick:u=>o.showMenu(u,{node:l,path:t}),oncontextmenu:u=>o.showMenu(u,{node:l,path:t}),"data-menu":"node",viewBox:"0 0 16 16"},e.hover&&m("path",{style:{transform:"translateY(-1px)"},fill:"currentColor","fill-rule":"evenodd",d:"M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"})),m("div",{class:"node-handle shrink-0",onclick:g,ondblclick:h,oncontextmenu:u=>o.showMenu(u,{node:l,path:t}),"data-menu":"node",style:{display:j()?"block":"none"}},W(i,"handleIcon")?ne(i,"handleIcon",y(i)>0&&!d):m("svg",{class:"node-bullet",viewBox:"0 0 16 16",xmlns:"http://www.w3.org/2000/svg"},y(i)>0&&!d?m("circle",{id:"node-collapsed-handle",cx:"8",cy:"8",r:"8"}):null,m("circle",{cx:"8",cy:"8",r:"3",fill:"currentColor"}),",",s?m("circle",{id:"node-reference-handle",cx:"8",cy:"8",r:"7",fill:"none","stroke-width":"1",stroke:"currentColor","stroke-dasharray":"3,3"}):null)),i.raw.Rel==="Fields"?m("div",{class:"flex grow items-start flex-row"},m("div",null,m(q,{workbench:o,path:t,onkeydown:w,oninput:b})),m(q,{editValue:!0,workbench:o,path:t,onkeydown:w,oninput:b})):m("div",{class:"flex grow items-start flex-row",style:{gap:"0.5rem"}},W(i,"beforeEditor")&&re(i,"beforeEditor").map(u=>m(u.beforeEditor(),{node:i,component:u})),m(q,{workbench:o,path:t,onkeydown:w,oninput:b,placeholder:c}),W(i,"afterEditor")&&re(i,"afterEditor").map(u=>m(u.afterEditor(),{node:i,component:u})))),W(i,"belowEditor")&&re(i,"belowEditor").map(u=>m(u.belowEditor(),{node:i,component:u,expanded:d})),d===!0&&m("div",{class:"expanded-node flex flex-row"},m("div",{class:"indent flex",onclick:g}),m("div",{class:"view grow"},m(he(i.getAttr("view")||"list"),{workbench:o,path:t}))))}};var Ae={view({attrs:{workbench:r,node:e}}){let n=new F(e,"quickadd");return m("div",{class:"notice"},m("h3",null,"Quick Add"),m(ae,{workbench:r,path:n,alwaysShowNew:!0}),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{r.commitQuickAdd(),r.closeDialog()}},"Add to Today")))}};var Pe={view({attrs:{workbench:r}}){let e=r.workspace.settings.theme;return m("div",{class:"notice"},m("form",{method:"dialog"},m("h3",null,"Settings"),m("div",{class:"flex flex-row"},m("div",{class:"grow"},"Theme"),m("div",null,m("select",{name:"theme"},m("option",{selected:e==="",value:""},"Light"),m("option",{selected:e==="darkmode",value:"darkmode"},"Dark"),m("option",{selected:e==="sepia",value:"sepia"},"Sepia"),m("option",{selected:e==="sublime",value:"sublime"},"Sublime")))),m("div",{class:"button-bar"},m("button",{onclick:()=>{r.closeDialog()}},"Cancel"),m("button",{class:"primary",onclick:async n=>{let t=n.target.closest("form").elements[0].value;e!==t?(r.workspace.settings.theme=t,await r.workspace.save(!0),location.reload()):r.closeDialog()}},"Save Changes"))))}};var Te={view(){return m("div",{class:"notice"},m("h3",null,"Refresh to view latest updates"),m("p",null,"Your notes were updated in another browser session. Refresh the page to view the latest version."),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{location.reload()}},"Refresh Now")))}},Fe={view({attrs:{workbench:r}}){return m("div",{class:"notice"},m("h3",null,"Treehouse is under active development"),m("p",null,"This is a preview based on our main branch, which is actively being developed."),m("p",null,"If you find a bug, please report it via \xA0",m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 14",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-menu"},m("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),m("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),m("line",{x1:"3",y1:"18",x2:"21",y2:"18"})),"\xA0> ",m("strong",null,"Submit Issue"),"."),m("p",null,"Data is stored using localstorage, which you can reset via \xA0",m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 14",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-menu"},m("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),m("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),m("line",{x1:"3",y1:"18",x2:"21",y2:"18"})),"\xA0> ",m("strong",null,"Reset Demo"),"."),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{localStorage.setItem("firsttime","1"),r.closeDialog()}},"Got it")))}},Be={view({attrs:{workbench:r,finished:e}}){return m("div",{class:"notice"},m("h3",null,"Login with GitHub"),m("p",null,"The GitHub backend is experimental so use at your own risk!"),m("p",null,"To store your workbench we will create a public repository called ",m("pre",{style:{display:"inline"}},"<username>.treehouse.sh")," if it doesn't already exist. You can manually make this repository private via GitHub if you want."),m("p",null,"You can Logout via the \xA0",m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 14",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-menu"},m("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),m("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),m("line",{x1:"3",y1:"18",x2:"21",y2:"18"})),"\xA0 menu in the top right to return to the localstorage backend."),m("div",{class:"button-bar"},m("button",{onclick:()=>{r.closeDialog()}},"Cancel"),m("button",{class:"primary",onclick:()=>{r.closeDialog(),localStorage.setItem("github","1"),e()}},"Log in with GitHub")))}};var Y=class{constructor(e){this.commands=new ee,this.keybindings=new Z,this.menus=new te,this.backend=e,this.workspace=new G(e.files),this.context={node:null},this.panels=[],this.dialog={body:()=>null},this.menu={body:()=>null}}get mainPanel(){return this.panels[0]}async initialize(){if(await this.workspace.load(),this.workspace.rawNodes.forEach(e=>this.backend.index.index(e)),this.workspace.observe(e=>{this.workspace.save(),e.isDestroyed?this.backend.index.remove(e.id):(this.backend.index.index(e.raw),e.components.forEach(n=>this.backend.index.index(n.raw)))}),this.workspace.lastOpenedID?this.openNewPanel(this.workspace.find(this.workspace.lastOpenedID)||this.workspace.mainNode()):this.openNewPanel(this.workspace.mainNode()),this.backend.loadExtensions&&await this.backend.loadExtensions(),this.workspace.settings.theme){let e=document.createElement("link");e.setAttribute("href",`https://treehouse.sh/style/themes/${this.workspace.settings.theme}.css`),e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),document.head.appendChild(e)}m.redraw()}authenticated(){return this.backend.auth&&this.backend.auth.currentUser()}openQuickAdd(){let e=this.workspace.find("@quickadd");e||(e=this.workspace.new("@quickadd")),this.showDialog(()=>m(Ae,{workbench:this,node:e}),!0),setTimeout(()=>{document.querySelector("main > dialog .new-node input").focus()},1)}commitQuickAdd(){let e=this.workspace.find("@quickadd");if(!e)return;let n=this.todayNode();e.children.forEach(t=>t.parent=n)}clearQuickAdd(){let e=this.workspace.find("@quickadd");e&&e.children.forEach(n=>n.destroy())}todayNode(){let e=new Date,n=e.toUTCString().split(e.getFullYear())[0],t=`Week ${String(Qe(e)).padStart(2,"0")}`,i=["@calendar",`${e.getFullYear()}`,t,n].join("/"),s=this.workspace.find(i);return s||(s=this.workspace.new(i)),s}openToday(){this.open(this.todayNode())}open(e){this.workspace.expanded[e.id]||(this.workspace.expanded[e.id]={}),this.workspace.lastOpenedID=e.id,this.workspace.save();let n=new F(e);this.panels[0]=n,this.context.path=n}openNewPanel(e){this.workspace.expanded[e.id]||(this.workspace.expanded[e.id]={}),this.workspace.lastOpenedID=e.id,this.workspace.save();let n=new F(e);this.panels.push(n),this.context.path=n}closePanel(e){this.panels=this.panels.filter(n=>n.name!==e.name)}defocus(){let e=this.getInput(this.context.path);e&&e.blur(),this.context.node=null,this.context.path=null}focus(e,n=0){let t=this.getInput(e);t?(this.context.path=e,t.focus(),n!==void 0&&t.setSelectionRange(n,n)):console.warn("unable to find input for",e)}getInput(e){let n=`input-${e.id}-${e.node.id}`;e.node.raw.Rel==="Fields"&&e.node.name!==""&&(n=n+"-value");let t=document.getElementById(n);return t.editor?t.editor:t}canExecuteCommand(e,n,...t){return n=this.newContext(n),this.commands.canExecuteCommand(e,n,...t)}executeCommand(e,n,...t){return n=this.newContext(n),console.log(e,n,...t),this.commands.executeCommand(e,n,...t)}newContext(e){return Object.assign({},this.context,e)}showMenu(e,n,t){e.stopPropagation(),e.preventDefault();let o=e.target.closest("*[data-menu]"),i=o.getBoundingClientRect();if(!t){let d=o.dataset.align||"left";t={top:`${document.body.scrollTop+i.y+i.height}px`},d==="right"?(t.marginLeft="auto",t.marginRight=`${document.body.offsetWidth-i.right}px`):(t.marginLeft=`${document.body.scrollLeft+i.x}px`,t.marginRight="auto")}let s=this.menus.menus[o.dataset.menu],l=s.filter(d=>d.command).map(d=>this.commands.commands[d.command]);s&&(this.menu={body:()=>m(ke,{workbench:this,ctx:this.newContext(n),items:s,commands:l}),style:t},m.redraw(),setTimeout(()=>{document.querySelector("main > dialog.menu").showModal()},0))}closeMenu(){document.querySelector("main > dialog.menu").close(),workbench.menu.body=()=>null}showPalette(e,n,t){this.showDialog(()=>m(be,{workbench:this,ctx:t}),!1,{left:`${e}px`,top:`${n}px`})}showNotice(e,n){this.showDialog(()=>m({firsttime:Fe,github:Be,lockstolen:Te}[e],{workbench:this,finished:n}),!0,void 0,e==="lockstolen")}showSettings(){this.showDialog(()=>m(Pe,{workbench:this}),!0)}showPopover(e,n){this.popover={body:e,style:n},m.redraw()}closePopover(){this.popover=null,m.redraw()}showDialog(e,n,t,o){this.dialog={body:e,backdrop:n,style:t,explicitClose:o},m.redraw(),setTimeout(()=>{document.querySelector("main > dialog.modal").showModal()},0)}isDialogOpen(){return document.querySelector("main > dialog.modal").hasAttribute("open")}closeDialog(){document.querySelector("main > dialog.modal").close(),this.dialog.body=()=>null}search(e){if(!e)return[];let n=e.split(/\s+(?=(?:[^\'"]*[\'"][^\'"]*[\'"])*[^\'"]*$)/),t=n.filter(l=>!l.includes(":")).join(" "),o=Object.fromEntries(n.filter(l=>l.includes(":")).map(l=>l.toLowerCase().split(":")));!t&&Object.keys(o).length>0&&(t=Object.keys(o)[0]);let i=a(l=>{if(Object.keys(o).length>0){let d={};for(let c of l.getLinked("Fields"))d[c.name.toLowerCase()]=c.value.toLowerCase();for(let c in o)if(!d[c]||d[c]!==o[c].replace(/['"]/g,""))return!1}return!0},"passFieldQuery");if(t.startsWith("#"))return D.findTagged(this.workspace,t.replace("#","")).filter(i);let s={};return this.backend.index.search(t).forEach(l=>{let d=window.workbench.workspace.find(l);d&&(d.value&&(d=d.parent,!d.raw)||i(d)&&(s[d.id]=d))}),Object.values(s)}};a(Y,"Workbench");function Qe(r){var e=new Date(Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())),n=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-n);var t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)}a(Qe,"getWeekOfYear");function Re(r){function e(E,C){var N=E<<C|E>>>32-C;return N}a(e,"rotate_left");function n(E){var C="",N,A,fe;for(N=0;N<=6;N+=2)A=E>>>N*4+4&15,fe=E>>>N*4&15,C+=A.toString(16)+fe.toString(16);return C}a(n,"lsb_hex");function t(E){var C="",N,A;for(N=7;N>=0;N--)A=E>>>N*4&15,C+=A.toString(16);return C}a(t,"cvt_hex");function o(E){E=E.replace(/\r\n/g,`
`);for(var C="",N=0;N<E.length;N++){var A=E.charCodeAt(N);A<128?C+=String.fromCharCode(A):A>127&&A<2048?(C+=String.fromCharCode(A>>6|192),C+=String.fromCharCode(A&63|128)):(C+=String.fromCharCode(A>>12|224),C+=String.fromCharCode(A>>6&63|128),C+=String.fromCharCode(A&63|128))}return C}a(o,"Utf8Encode");var i,s,l,d=new Array(80),c=1732584193,p=4023233417,f=2562383102,v=271733878,b=3285377520,w,h,g,y,j,x;r=o(r);var u=r.length,B=new Array;for(s=0;s<u-3;s+=4)l=r.charCodeAt(s)<<24|r.charCodeAt(s+1)<<16|r.charCodeAt(s+2)<<8|r.charCodeAt(s+3),B.push(l);switch(u%4){case 0:s=2147483648;break;case 1:s=r.charCodeAt(u-1)<<24|8388608;break;case 2:s=r.charCodeAt(u-2)<<24|r.charCodeAt(u-1)<<16|32768;break;case 3:s=r.charCodeAt(u-3)<<24|r.charCodeAt(u-2)<<16|r.charCodeAt(u-1)<<8|128;break}for(B.push(s);B.length%16!=14;)B.push(0);for(B.push(u>>>29),B.push(u<<3&4294967295),i=0;i<B.length;i+=16){for(s=0;s<16;s++)d[s]=B[i+s];for(s=16;s<=79;s++)d[s]=e(d[s-3]^d[s-8]^d[s-14]^d[s-16],1);for(w=c,h=p,g=f,y=v,j=b,s=0;s<=19;s++)x=e(w,5)+(h&g|~h&y)+j+d[s]+1518500249&4294967295,j=y,y=g,g=e(h,30),h=w,w=x;for(s=20;s<=39;s++)x=e(w,5)+(h^g^y)+j+d[s]+1859775393&4294967295,j=y,y=g,g=e(h,30),h=w,w=x;for(s=40;s<=59;s++)x=e(w,5)+(h&g|h&y|g&y)+j+d[s]+2400959708&4294967295,j=y,y=g,g=e(h,30),h=w,w=x;for(s=60;s<=79;s++)x=e(w,5)+(h^g^y)+j+d[s]+3395469782&4294967295,j=y,y=g,g=e(h,30),h=w,w=x;c=c+w&4294967295,p=p+h&4294967295,f=f+g&4294967295,v=v+y&4294967295,b=b+j&4294967295}var x=t(c)+t(p)+t(f)+t(v)+t(b);return x.toLowerCase()}a(Re,"SHA1");var F=class{constructor(e,n){n?this.name=n:this.name=Math.random().toString(36).substring(2),e?this.nodes=[e]:this.nodes=[]}push(e){this.nodes.push(e)}pop(){return this.nodes.pop()||null}sub(){return new F(this.node,this.name)}clone(){let e=new F;return e.name=this.name,e.nodes=[...this.nodes],e}append(e){let n=this.clone();return n.push(e),n}get length(){return this.nodes.length}get id(){return Re([this.name,...this.nodes.map(e=>e.id)].join(":"))}get node(){return this.nodes[this.nodes.length-1]}get previous(){return this.nodes.length<2?null:this.nodes[this.nodes.length-2]}get head(){return this.nodes[0]}};a(F,"Path");var X=class{constructor(){this.nodes={"@root":{ID:"@root",Name:"@root",Linked:{Children:[],Components:[]},Attrs:{}}},this.observers=[]}changed(e){this.observers.forEach(n=>n(e))}import(e){for(let n of e)n.Value&&K(n.Name)&&(n.Value=xe(n.Name,n.Value),n.Rel="Components"),this.nodes[n.ID]=n;for(let n of e){if(n.Parent==="@tmp"){delete this.nodes[n.ID];continue}if(!n.ID.startsWith("@")&&n.Parent===void 0){delete this.nodes[n.ID];continue}if(n.Parent&&!this.nodes[n.Parent]){delete this.nodes[n.ID];continue}let t=this.find(n.ID);if(t){if(t.parent&&!t.parent.raw){delete this.nodes[n.ID];continue}V(t,"onAttach",t)}}}export(){let e=[];for(let n of Object.values(this.nodes))e.push(n);return e}make(e,n){let t=null;if(e.includes("/")){let s=e.split("/");t=this.find(s[0]);for(let l=1;l<s.length-1;l++){if(t===null)throw"unable to get root";let d=t.find(s[l]);d||(d=this.make(s.slice(0,l+1).join("/"))),t=d}e=s[s.length-1]}let o=e.startsWith("@")?e:Je();this.nodes[o]={ID:o,Name:e,Value:n,Linked:{Children:[],Components:[]},Attrs:{}};let i=new L(this,o);return t&&(i.parent=t),i}destroy(e){let n=e.parent;if(n!==null&&!n.isDestroyed){let t=e.raw.Rel||"Children";n.raw.Linked[t].includes(e.id)&&n.raw.Linked[t].splice(e.siblingIndex,1)}delete this.nodes[e.id],n&&this.changed(n)}roots(){return Object.values(this.nodes).filter(e=>e.Parent===void 0).map(e=>new L(this,e.ID))}root(e){e=e||"@root";let n=this.roots().find(t=>t.name===e);return n===void 0?null:n}find(e){let n=this.nodes[e];if(n)return new L(this,n.ID);let t=e.split("/");if(t.length===1&&t[0].startsWith("@"))return null;let o=this.root(t[0]);if(!o&&this.nodes[t[0]]&&(o=new L(this,this.nodes[t[0]].ID)),o?t.shift():o=this.root("@root"),!o)return null;let i=a((s,l)=>(s.refTo&&(s=s.refTo),s.children.find(d=>d.name===l)),"findChild");for(let s of t){let l=i(o,s);if(!l)return null;o=l}return o}walk(e,n){for(let t of this.roots())if(t.walk(e,n))return}observe(e){this.observers.push(e)}};a(X,"Bus");var Je=a(()=>{let r=Date.now().toString(36),e=Math.random().toString(36).substring(2);return r+e},"uniqueId");var L=class{constructor(e,n){this._bus=e,this._id=n}[Symbol.for("Deno.customInspect")](){return`Node[${this.id}:${this.name}]`}get id(){return this._id}get bus(){return this._bus}get raw(){let e=this._bus.nodes[this.id];if(!e)throw`use of non-existent node ${this.id}`;return e}get name(){return this.refTo?this.refTo.name:this.raw.Name}set name(e){this.refTo?this.refTo.name=e:this.raw.Name=e,this.changed()}get value(){return this.refTo?this.refTo.value:this.raw.Value}set value(e){this.refTo?this.refTo.value=e:this.raw.Value=e,this.changed()}get parent(){return!this.raw.Parent||!this._bus.nodes[this.raw.Parent]?null:new L(this._bus,this.raw.Parent)}set parent(e){let n=this.parent;n!==null&&n.raw.Linked.Children.splice(this.siblingIndex,1),e!==null?(this.raw.Parent=e.id,e.raw.Linked.Children.push(this.id),V(e,"onAttach",e)):this.raw.Parent=void 0,this.changed()}get refTo(){let e=this.raw.Attrs.refTo;return!e||!this._bus.nodes[e]?null:new L(this._bus,e)}set refTo(e){if(!e){delete this.raw.Attrs.refTo,this.changed();return}this.raw.Attrs.refTo=e.id,this.changed()}get siblingIndex(){let e=this.parent;if(e===null)return 0;let n=this.raw.Rel||"Children";return e.raw.Linked[n].findIndex(t=>t===this.id)}set siblingIndex(e){let n=this.parent;if(n===null)return;let t=this.raw.Rel||"Children";n.raw.Linked[t].splice(this.siblingIndex,1),n.raw.Linked[t].splice(e,0,this.id),n.changed()}get prevSibling(){let e=this.parent;if(e===null||this.siblingIndex===0)return null;let n=this.raw.Rel||"Children";return e.getLinked(n)[this.siblingIndex-1]}get nextSibling(){let e=this.parent;if(e===null||this.siblingIndex===e.children.length-1)return null;let n=this.raw.Rel||"Children";return e.getLinked(n)[this.siblingIndex+1]}get ancestors(){let e=[],n=this.parent;for(;n!==null;)e.push(n),n=n.parent;return e}get isDestroyed(){return!this._bus.nodes.hasOwnProperty(this.id)}get path(){let e=this,n=[];for(;e;)n.unshift(e.name),e=e.parent;return n.join("/")}get children(){if(this.refTo)return this.refTo.children;let e=[];this.raw.Linked.Children&&(e=this.raw.Linked.Children.map(n=>new L(this._bus,n)));for(let n of this.components)if(z(n,"objectChildren"))return V(n,"objectChildren",this,e);return e}get childCount(){if(this.refTo)return this.refTo.childCount;for(let e of this.components)if(z(e,"objectChildren"))return V(e,"objectChildren",this,null).length;return this.raw.Linked.Children?this.raw.Linked.Children.length:0}addChild(e){if(this.refTo){this.refTo.addChild(e);return}this.raw.Linked.Children.push(e.id),this.changed()}removeChild(e){if(this.refTo){this.refTo.removeChild(e);return}let n=this.raw.Linked.Children.filter(t=>t===e.id);this.raw.Linked.Children=n,this.changed()}get fields(){return this.raw.Linked.Fields?this.raw.Linked.Fields.map(e=>new L(this._bus,e)):[]}get fieldCount(){return this.raw.Linked.Fields?this.raw.Linked.Fields.length:0}get components(){return this.raw.Linked.Components?this.raw.Linked.Components.map(e=>new L(this._bus,e)):[]}get componentCount(){return this.raw.Linked.Components?this.raw.Linked.Components.length:0}addComponent(e){let n=this.bus.make(Q(e),e);n.raw.Parent=this.id,n.raw.Rel="Components",this.raw.Linked.Components.push(n.id),V(n,"onAttach",n),this.changed()}removeComponent(e){let n;e.name&&K(e)?n=this.components.filter(t=>t.name===Q(e)):n=this.components.filter(t=>t.value===e),n.length>0&&n[0].destroy(),this.changed()}hasComponent(e){return this.components.filter(t=>t.name===Q(e)).length>0}getComponent(e){let n=this.components.filter(t=>t.name===Q(e));return n.length>0?n[0].value:null}getLinked(e){return this.raw.Linked[e]?this.raw.Linked[e].map(n=>new L(this._bus,n)):[]}addLinked(e,n){this.raw.Linked[e]||(this.raw.Linked[e]=[]),n.raw.Rel=e,this.raw.Linked[e].push(n.id),this.changed()}removeLinked(e,n){this.raw.Linked[e]||(this.raw.Linked[e]=[]);let t=this.raw.Linked[e].filter(o=>o===n.id);this.raw.Linked[e]=t,this.changed()}moveLinked(e,n,t){this.raw.Linked[e]||(this.raw.Linked[e]=[]);let o=this.raw.Linked[e].findIndex(s=>s===n.id);if(o===-1)return;let i=this.raw.Linked[e];i.splice(t,0,i.splice(o,1)[0]),this.raw.Linked[e]=i,this.changed()}getAttr(e){return this.raw.Attrs[e]||""}setAttr(e,n){this.raw.Attrs[e]=n,this.changed()}find(e){return this.bus.find([this.path,e].join("/"))}walk(e,n){if(n=n||{followRefs:!1,includeComponents:!1},e(this))return!0;let t=this.children;if(this.refTo&&n.followRefs){if(e(this.refTo))return!0;t=this.refTo.children}for(let o of t)if(o.walk(e,n))return!0;if(n.includeComponents){for(let o of this.components)if(o.walk(e,n))return!0}return!1}destroy(){if(this.isDestroyed)return;if(this.refTo){this._bus.destroy(this);return}let e=[];this.walk(n=>(e.push(n),!1),{followRefs:!1,includeComponents:!0}),e.reverse().forEach(n=>this._bus.destroy(n))}duplicate(){let e=this._bus.make(this.name,Ce(this.value));return e.raw.Rel=this.raw.Rel,this.fields.map(n=>n.duplicate()).forEach(n=>{e.addLinked("Fields",n),n.raw.Parent=e.raw.ID}),this.components.map(n=>n.duplicate()).forEach(n=>{e.addLinked("Components",n),n.raw.Parent=e.raw.ID}),this.children.map(n=>n.duplicate()).forEach(n=>{e.addChild(n),n.raw.Parent=e.raw.ID}),e}changed(){this._bus.changed(this)}};a(L,"Node");var G=class{constructor(e){this.fs=e,this.bus=new X,this.expanded={},this.settings={},this.writeDebounce=Ye(async(n,t)=>{try{await this.fs.writeFile(n,t),console.log("Saved workspace.")}catch(o){console.error(o),document.dispatchEvent(new CustomEvent("BackendError"))}})}get rawNodes(){return this.bus.export()}observe(e){this.bus.observe(e)}async save(e){let n=JSON.stringify({version:1,lastopen:this.lastOpenedID,expanded:this.expanded,nodes:this.rawNodes,settings:this.settings},null,2);e?await this.fs.writeFile("workspace.json",n):this.writeDebounce("workspace.json",n)}async load(){let e=JSON.parse(await this.fs.readFile("workspace.json")||"{}");if(e.nodes&&(e.nodes=e.nodes.map(n=>(n.Name==="treehouse.SearchNode"&&(n.Name="treehouse.SmartNode"),n)),this.bus.import(e.nodes),console.log(`Loaded ${e.nodes.length} nodes.`)),e.expanded)for(let n in e.expanded)for(let t in e.expanded[n])this.bus.find(t)&&(this.expanded[n]||(this.expanded[n]={}),this.expanded[n][t]=e.expanded[n][t]);e.lastopen&&(this.lastOpenedID=e.lastopen),e.settings&&(this.settings=Object.assign(this.settings,e.settings))}mainNode(){let e=this.bus.find("@workspace");if(!e){console.info("Building missing workspace node.");let n=this.bus.find("@root"),t=this.bus.make("@workspace");t.name="Workspace",t.parent=n;let o=this.bus.make("@calendar");o.name="Calendar",o.parent=t;let i=this.bus.make("Home");i.parent=t,e=t}return e}find(e){return this.bus.find(e)}new(e,n){return this.bus.make(e,n)}getExpanded(e,n){this.expanded[e.id]||(this.expanded[e.id]={});let t=this.expanded[e.id][n.id];return t===void 0&&(t=!1),t}setExpanded(e,n,t){this.expanded[e.id]||(this.expanded[e.id]={}),this.expanded[e.id][n.id]=t,this.save()}findAbove(e){if(e.node.id===e.head.id)return null;let n=e.clone();n.pop();let t=e.node.prevSibling;if(!t){let i=e.previous.getLinked("Fields").length;return e.node.raw.Rel!=="Fields"&&i>0?n.append(e.previous.getLinked("Fields")[i-1]):n}let o=a(i=>{if(!this.getExpanded(e.head,i.node))return i;let l=i.node.getLinked("Fields").length;if(i.node.childCount===0&&l>0){let c=i.node.getLinked("Fields")[l-1];return o(i.append(c))}if(i.node.childCount===0)return i;let d=i.node.children[i.node.childCount-1];return o(i.append(d))},"lastSubIfExpanded");return o(n.append(t))}findBelow(e){let n=e.clone();if(this.getExpanded(e.head,e.node)&&e.node.getLinked("Fields").length>0)return n.append(e.node.getLinked("Fields")[0]);if(this.getExpanded(e.head,e.node)&&e.node.childCount>0)return n.append(e.node.children[0]);let t=a(o=>{let i=o.node.nextSibling;if(i)return o.pop(),o.append(i);let s=o.previous;return s?o.node.raw.Rel==="Fields"&&s.childCount>0?(o.pop(),o.append(s.children[0])):(o.pop(),t(o)):null},"nextSiblingOrParentNextSibling");return t(n)}};a(G,"Workspace");function Ye(r,e=3e3){let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>{r.apply(this,t)},e)}}a(Ye,"debounce");var P=class{constructor(){this.markdown=""}};a(P,"Page"),P=S([I],P);var je={view({attrs:r}){let e=r.path,n=r.workbench,t=e.node,o=a(p=>{n.executeCommand("close-panel",{},e)},"close"),i=a(p=>{e.pop()},"goBack"),s=a(p=>{n.panels=[e],n.context.path=e},"maximize"),l=a(p=>{t.getComponent(P).markdown=p.target.value,t.changed()},"editMarkdown");function d(p=""){return 20+(p.match(/\n/g)||[]).length*20}a(d,"calcHeight");let c="";return t.getAttr("view")&&(c=`${t.getAttr("view")}-panel`),m("div",{class:`panel flex flex-col grow ${c}`},m("div",{class:"bar flex"},e.length>1?m("div",{class:"panel-back",style:{rightPadding:"var(--padding)"}},m("svg",{onclick:i,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{"fill-rule":"evenodd",d:"M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"}))):null,m("div",{class:"panel-back-parent grow"},t.parent&&t.parent.id!=="@root"?m("span",{style:{cursor:"pointer"},onclick:()=>n.open(t.parent)},t.parent.name):m("span",null,"\xA0")),n.panels.length>1?m("div",{class:"panel-icons flex items-center"},m("svg",{onclick:s,style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-maximize-2"},m("polyline",{points:"15 3 21 3 21 9"}),m("polyline",{points:"9 21 3 21 3 15"}),m("line",{x1:"21",y1:"3",x2:"14",y2:"10"}),m("line",{x1:"3",y1:"21",x2:"10",y2:"14"})),m("svg",{onclick:o,style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-x"},m("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),m("line",{x1:"6",y1:"6",x2:"18",y2:"18"}))):null),m("div",{class:"body flex flex-col"},m("div",{class:"title-node",oncontextmenu:p=>n.showMenu(p,{node:t,path:e}),"data-menu":"node"},m(q,{workbench:n,path:e,disallowEmpty:!0})),t.hasComponent(P)?m("textarea",{oninput:l,value:t.getComponent(P).markdown,placeholder:"Enter Markdown text here",style:{marginLeft:"var(--padding)",padding:"var(--padding)",outline:"0",height:`${d(t.getComponent(P).markdown)}px`,border:"0"}},t.getComponent(P).markdown):null,m(ae,{workbench:n,path:e.sub(),alwaysShowNew:!0})))}};var me={view({attrs:{input:r,workbench:e}}){return m("div",{class:"search"},m(J,{onpick:a(o=>{e.closeDialog(),e.open(o)},"onpick"),onchange:a(o=>{o.input?o.items=e.search(o.input):o.items=[]},"onchange"),input:r,inputview:(o,i,s)=>m("div",{class:"flex items-center"},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-search shrink-0 items-center"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})),m("input",{type:"text",placeholder:"Search",value:s,onkeydown:o,oninput:i})),itemview:o=>m("div",null,o.name)}))}};var Oe={view({attrs:{workbench:r},state:e}){e.open=e.open===void 0?!0:e.open;let n=a(t=>{e.open?e.open=!1:e.open=!0},"toggle");return m("main",{class:"workbench m-0 flex flex-row absolute inset-0",style:{overflow:"none"}},m("div",{class:"sidebar flex flex-col",style:{width:e.open?"256px":"52px"}},m("div",{class:"sidebar-top",style:{height:"56px"}},m("div",{class:"logo"})),m("div",{class:"grow sidebar-main"},e.open&&r.workspace.bus.root().children.map(t=>m(Me,{node:t,expanded:!0,level:0,workbench:r}))),m("div",{class:"sidebar-bottom"},m("svg",{onclick:n,xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-sidebar"},m("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"9",y1:"3",x2:"9",y2:"21"})))),m("div",{class:"main flex flex-col grow"},m("div",{class:"topbar flex"},m("div",{class:"topbar-item",onclick:()=>r.openToday(),style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)",display:"flex",alignItems:"center"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-calendar"},m("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),m("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),m("line",{x1:"3",y1:"10",x2:"21",y2:"10"})),m("div",null,"Today")),m("div",{class:"topbar-item",onclick:()=>r.openQuickAdd(),style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)",display:"flex",alignItems:"center"}},m("svg",{style:{marginRight:"var(--1)"},xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-plus-circle"},m("circle",{cx:"12",cy:"12",r:"10"}),m("line",{x1:"12",y1:"8",x2:"12",y2:"16"}),m("line",{x1:"8",y1:"12",x2:"16",y2:"12"})),m("div",null,"Quick Add")),m("div",{class:"searchbar flex grow"},m("div",null,m("div",{class:"flex",style:{margin:"1px"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-search shrink-0"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})),m("input",{type:"text",placeholder:"Search",onkeydown:t=>{if(t.key==="Control"||t.key==="Alt"||t.key==="Shift"||t.key==="Meta")return;let o=t.target.getBoundingClientRect();r.showDialog(()=>m(me,{workbench:r,input:t.key}),!1,{left:`${o.left-33}px`,top:`${o.top-9}px`,width:`${o.width+33}px`}),t.preventDefault()},style:{border:"0",outline:"0",background:"transparent",paddingTop:"3px"}})))),m("div",{onclick:t=>r.showMenu(t),"data-menu":"settings","data-align":"right",style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-menu"},m("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),m("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),m("line",{x1:"3",y1:"18",x2:"21",y2:"18"})))),m("div",{class:"panels flex flex-row grow",style:{position:"relative",overflow:"hidden"}},r.panels.map(t=>m("div",null,m(je,{workbench:r,path:t})))),m("div",{class:"mobile-nav flex-row"},m("div",null,m("svg",{onclick:()=>{let t=document.querySelector(".sidebar").style;t.display!=="flex"?t.display="flex":t.display="none"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-sidebar"},m("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"9",y1:"3",x2:"9",y2:"21"}))),m("div",{onclick:()=>r.openToday()},m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-calendar"},m("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),m("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),m("line",{x1:"3",y1:"10",x2:"21",y2:"10"}))),m("div",{onclick:()=>r.openQuickAdd()},m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-plus-circle"},m("circle",{cx:"12",cy:"12",r:"10"}),m("line",{x1:"12",y1:"8",x2:"12",y2:"16"}),m("line",{x1:"8",y1:"12",x2:"16",y2:"12"}))),m("div",{onclick:()=>r.showDialog(()=>m(me,{workbench:r}),!0,{top:"25%",bottom:"100px"})},m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-search shrink-0"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}))),m("div",{onclick:t=>r.showMenu(t,void 0,{bottom:"100px",marginTop:"auto"}),"data-menu":"settings"},m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-menu"},m("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),m("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),m("line",{x1:"3",y1:"18",x2:"21",y2:"18"}))))),r.popover&&m("div",{class:"popover",style:{position:"absolute",...r.popover.style}},r.popover.body()),m("dialog",{class:r.dialog.backdrop?"popover modal backdrop":"popover modal",style:r.dialog.style?{margin:"0",...r.dialog.style}:{top:"-50%"},oncancel:t=>{if(r.dialog.explicitClose===!0){t.preventDefault();return}r.dialog.body=()=>null},onclick:t=>{let i=t.target.closest("dialog").getBoundingClientRect();r.dialog.explicitClose!==!0&&(t.clientX<i.left||t.clientX>i.right||t.clientY<i.top||t.clientY>i.bottom)&&r.closeDialog()}},r.dialog.body()),m("dialog",{class:"menu popover",style:{margin:"0",...r.menu.style},oncancel:t=>{r.menu.body=()=>null},onclick:t=>{let i=t.target.closest("dialog").getBoundingClientRect();(t.clientX<i.left||t.clientX>i.right||t.clientY<i.top||t.clientY>i.bottom)&&r.closeMenu()}},r.menu.body()))}},Me={view({attrs:{node:r,workbench:e,expanded:n,level:t},state:o}){o.expanded=o.expanded===void 0?n:o.expanded;let i=r.childCount>0&&t<3,s=a(d=>{i&&(o.expanded?o.expanded=!1:o.expanded=!0,d.stopPropagation())},"toggle"),l=a(d=>{document.querySelector(".mobile-nav").offsetHeight&&(document.querySelector(".sidebar").style.display="none"),e.open(r)},"open");return m("div",null,m("div",{class:"sidebar-item flex"},m("svg",{onclick:s,class:"feather feather-chevron-right shrink-0",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",xmlns:"http://www.w3.org/2000/svg"},i?o.expanded?m("polyline",{points:"6 9 12 15 18 9"}):m("polyline",{points:"9 18 15 12 9 6"}):null),m("div",{class:"sidebar-item-label grow",onclick:l,style:{cursor:"pointer",maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},r.name)),o.expanded&&m("div",{class:"sidebar-item-nested"},r.children.filter(d=>d.name!=="").map(d=>m(Me,{workbench:e,node:d,level:t+1}))))}};var T=class{constructor(){this.checked=!1}beforeEditor(){return Ge}};a(T,"Checkbox"),T=S([I],T);var Ge={view({attrs:{node:r}}){return m("input",{type:"checkbox",style:{marginTop:"0.3rem"},onclick:a(n=>{let t=r.getComponent(T);t.checked=!t.checked,r.changed()},"toggleCheckbox"),checked:r.getComponent(T).checked})}};var U=class{constructor(){}handleIcon(){return m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("polyline",{points:"4 7 4 4 20 4 20 7"}),m("line",{x1:"9",y1:"20",x2:"15",y2:"20"}),m("line",{x1:"12",y1:"4",x2:"12",y2:"20"}))}};a(U,"TextField"),U=S([I],U);var k=class{constructor(){this.log=[],this.showLog=!1}onAttach(e){this.component=e,this.object=e.parent}fromJSON(e){e.startedAt&&(this.startedAt=new Date(e.startedAt)),this.log=(e.log||[]).map(n=>[new Date(n[0]),new Date(n[1])]),this.showLog=e.showLog}toJSON(e){return{startedAt:this.startedAt,log:this.log,showLog:this.showLog}}localTotal(){return this.log.map(this.entryDuration).reduce((e,n)=>e+n,0)}grandTotal(){let e=this.localTotal();return this.object&&this.object.children.forEach(n=>{n.hasComponent(k)&&(e+=n.getComponent(k).grandTotal())}),e}start(){this.startedAt||(this.startedAt=new Date)}stop(){if(!this.startedAt)return;let e=new Date;(e.getTime()-this.startedAt.getTime())/1e3>=60&&this.log.push([this.startedAt,e]),this.startedAt=void 0}formatEntry(e){return e.length!==2?"":`${this.formatDate(e[0])} - ${new Intl.DateTimeFormat("en",{timeStyle:"short"}).format(e[1])}`}entryDuration(e){let n=e[0];return((e[1]||new Date).getTime()-n.getTime())/1e3}formatDate(e){return e?new Intl.DateTimeFormat("en",{dateStyle:"short",timeStyle:"short"}).format(e):""}formatDuration(e){let n=e/60,t=Math.floor(n%60);return n=n/60,`${Math.floor(n%60)}:${t.toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1})}`}afterEditor(){return Xe}belowEditor(){return _e}static initialize(e){e.commands.registerCommand({id:"stop-clock",title:"Stop clock",action:n=>{if(n.node){if(!n.node.hasComponent(k)){let t=new k;n.node.addComponent(t)}n.node.getComponent(k).stop(),n.node.changed()}}}),e.keybindings.registerBinding({command:"stop-clock",key:"meta+o"}),e.commands.registerCommand({id:"start-clock",title:"Start clock",action:n=>{if(n.node){if(!n.node.hasComponent(k)){let t=new k;n.node.addComponent(t)}n.node.getComponent(k).start(),n.node.changed()}}}),e.keybindings.registerBinding({command:"start-clock",key:"meta+i"}),e.commands.registerCommand({id:"remove-clock",title:"Remove clock",action:n=>{n.node&&n.node.removeComponent(k)}})}};a(k,"Clock"),k=S([I],k);var Xe={view({attrs:{node:r}}){let e=r.getComponent(k),n=a(()=>{e.showLog=!e.showLog,r.changed()},"toggleLog");return!e.showLog&&e.startedAt?m("div",{tabindex:"1",onclick:n,class:"badge flex flex-row items-center",style:{background:"green",lineHeight:"var(--body-line-height)",paddingLeft:"0.25rem",paddingRight:"0.25rem",borderRadius:"4px",color:"white"}},m("svg",{class:"blink",style:{width:"1rem",height:"1rem",marginRight:"0.25rem"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"12",cy:"12",r:"10"}),m("polyline",{points:"12 6 12 12 16 14"})),m("div",null,e.formatDuration(e.entryDuration([e.startedAt])))):m("div",{tabindex:"1",onclick:n,class:"badge flex flex-row items-center",style:{background:"gray",lineHeight:"var(--body-line-height)",paddingLeft:"0.25rem",paddingRight:"0.25rem",borderRadius:"4px",color:"white"}},m("svg",{style:{width:"1rem",height:"1rem",marginRight:"0.25rem"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"12",cy:"12",r:"10"}),m("polyline",{points:"12 6 12 12 16 14"})),m("div",null,e.formatDuration(e.grandTotal())))}},_e={view({attrs:{node:r}}){let e=r.getComponent(k);if(e.showLog)return m("div",{class:"expanded-node flex flex-row"},m("div",{class:"indent flex"}),m("div",{class:"grow"},e.startedAt&&m("div",{class:"flex flex-row",style:{marginBottom:"2px"}},m("div",{class:"grow"},e.formatDate(e.startedAt)," - ..."),m("div",{class:"flex flex-row items-center",style:{background:"green",lineHeight:"var(--body-line-height)",paddingLeft:"0.25rem",paddingRight:"0.25rem",borderRadius:"4px",color:"white"}},m("svg",{class:"blink",style:{width:"1rem",height:"1rem",marginRight:"0.25rem"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"12",cy:"12",r:"10"}),m("polyline",{points:"12 6 12 12 16 14"})),m("div",null,e.formatDuration(e.entryDuration([e.startedAt]))))),e.log.toReversed().map(n=>m("div",{class:"flex flex-row",style:{marginBottom:"2px"}},m("div",{class:"grow"},e.formatEntry(n)),m("div",{class:"flex flex-row items-center",style:{background:"#aaa",lineHeight:"var(--body-line-height)",paddingLeft:"0.25rem",paddingRight:"0.25rem",borderRadius:"4px",color:"white"}},m("svg",{style:{width:"1rem",height:"1rem",marginRight:"0.25rem"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"12",cy:"12",r:"10"}),m("polyline",{points:"12 6 12 12 16 14"})),m("div",null,e.formatDuration(e.entryDuration(n))))))))}};var _=class{constructor(){this.auth=null,this.files=new le,window.MiniSearch?this.index=new oe:this.index=new de}};a(_,"BrowserBackend");var oe=class{constructor(){this.indexer=new MiniSearch({idField:"ID",fields:["ID","Name","Value","Value.markdown"],storeFields:["ID"],extractField:(e,n)=>n.split(".").reduce((t,o)=>t&&t[o],e)})}index(e){this.indexer.has(e.ID)?this.indexer.replace(e):this.indexer.add(e)}remove(e){try{this.indexer.discard(e)}catch{}}search(e){let n=this.indexer.autoSuggest(e);return n.length===0?[]:this.indexer.search(n[0].suggestion,{prefix:!0,combineWith:"AND"}).map(t=>t.ID)}};a(oe,"SearchIndex_MiniSearch");var de=class{constructor(){this.nodes={}}index(e){this.nodes[e.ID]=e.Name}remove(e){delete this.nodes[e]}search(e){let n=[];for(let t in this.nodes)this.nodes[t].includes(e)&&n.push(t);return n}};a(de,"SearchIndex_Dumb");var le=class{async readFile(e){return localStorage.getItem(`treehouse:${e}`)}async writeFile(e,n){localStorage.setItem(`treehouse:${e}`,n)}};a(le,"FileStore");import{encode as Ze,decode as et}from"https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.mjs";var ce=class{constructor(e,n,t){this.loginURL=e,this.clientFactory=n,this.auth=this,this.shas={},this.opts=Object.assign({domain:"treehouse.sh",checkDomain:!1,privateRepo:!1},t||{});let o=new _;this.index=o.index,this.files=o.files}get repoName(){return`${this.user?.userID().toLowerCase()}.${this.opts.domain}`}async initialize(){let e=new URL(location.href).searchParams.get("code");if(e)try{let i=location.search.replace(/\bcode=\w+/,"").replace(/\?$/,"");history.pushState({},"",`${location.pathname}${i}`);let l=await(await fetch(this.loginURL,{method:"POST",mode:"cors",headers:{"content-type":"application/json"},body:JSON.stringify({code:e})})).json();if(l.error)throw l.error;localStorage.setItem("treehouse:gh-token",l.token)}catch(i){this.reset(),console.error(i);return}let n=new URL(location.href).searchParams.get("access_token");if(n)try{let i=location.search.replace(/\baccess_token=\w+/,"").replace(/\?$/,"");history.pushState({},"",`${location.pathname}${i}`),localStorage.setItem("treehouse:gh-token",n)}catch(i){this.reset(),console.error(i);return}try{if(await this.authenticate(),!this.user)throw"authentication failed"}catch(i){console.error(i),this.opts.authFallbackURL&&(location.href=this.opts.authFallbackURL);return}if(this.opts.checkDomain&&this.repoName!==location.hostname.toLowerCase()){location.hostname=this.repoName;return}try{await this.client.rest.repos.get({owner:this.user.userID(),repo:this.repoName})}catch(i){if(i.message!=="Not Found")throw i;console.log("Creating repository...");let s=await this.client.rest.repos.createForAuthenticatedUser({name:this.repoName,private:this.opts.privateRepo});if(s.status!==201){console.error(s);return}}try{await this.client.rest.repos.getContent({owner:this.user.userID(),repo:this.repoName,path:"workspace.json"})}catch(i){if(i.name!=="HttpError")throw i;console.log("Creating workspace.json...");let s=await this.client.rest.repos.createOrUpdateFileContents({owner:this.user.userID(),repo:this.repoName,path:"workspace.json",message:"initial commit",content:btoa(JSON.stringify([]))});if(s.status!==201){console.error(s);return}}this.files=this;let t=tt();await this.readFile("treehouse.lock"),await this.writeFile("treehouse.lock",t);let o=setInterval(async()=>{await this.readFile("treehouse.lock")!==t&&(clearInterval(o),document.dispatchEvent(new CustomEvent("BackendError")),console.warn("lock stolen!"))},5e3)}async loadExtensions(){try{if((await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repoName,path:"",random:Math.random().toString(36).substring(2)})).data.find(n=>n.type==="dir"&&n.name==="ext")){let n=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repoName,path:"ext",random:Math.random().toString(36).substring(2)});for(let t of n.data)if(t.name.endsWith(".css")){let o=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repoName,path:t.path,random:Math.random().toString(36).substring(2)}),i=document.createElement("link");i.setAttribute("href",`data:text/css;charset=utf-8;base64,${o.data.content}`),i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),document.head.appendChild(i)}else if(t.name.endsWith(".js")){let o=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repoName,path:t.path,random:Math.random().toString(36).substring(2)}),i=document.createElement("script");i.setAttribute("type","module"),i.setAttribute("src",`data:text/javascript;charset=utf-8;base64,${o.data.content}`),document.head.appendChild(i)}}}catch{}}async authenticate(){let e=localStorage.getItem("treehouse:gh-token");if(!e)return;this.client=new this.clientFactory({auth:e});let n=await this.client.rest.users.getAuthenticated();!n||n.error||(this.user=new ue(n.data),m&&m.redraw())}currentUser(){return this.user}login(){location.assign(this.loginURL)}reset(){localStorage.removeItem("treehouse:gh-token"),this.user=null,m&&m.redraw()}logout(){this.reset(),location.reload()}async readFile(e){try{let n=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repoName,path:e,random:Math.random().toString(36).substring(2)});return this.shas[e]=n.data.sha,et(n.data.content)}catch(n){return n.name!=="HttpError"&&console.error(n),null}}async writeFile(e,n){let t=await this.client.rest.repos.createOrUpdateFileContents({owner:this.user?.userID(),repo:this.repoName,path:e,message:"autosave",content:Ze(n),sha:this.shas[e]});this.shas[e]=t.data.content.sha}};a(ce,"GitHubBackend");var ue=class{constructor(e){this.user=e}userID(){return this.user.login}displayName(){return this.user.name}avatarURL(){return this.user.avatar_url}};a(ue,"User");function tt(){let r=Date.now().toString(36),e=Math.random().toString(36).substring(2);return r+e}a(tt,"uniqueID");async function Go(r,e,n){n.initialize&&await n.initialize();let t=new Y(n);window.workbench=t,await t.initialize(),[k,U,P,R,T,D,M,H].forEach(o=>{o.initialize&&o.initialize(t)}),r.addEventListener("BackendError",()=>{t.showNotice("lockstolen",()=>{location.reload()})}),t.commands.registerCommand({id:"cut",title:"Cut",when:o=>{if(!o.node)return!1;let i=t.getInput(o.path);return i&&i.selectionStart===i.selectionEnd?!0:(t.clipboard=void 0,!1)},action:o=>{t.clipboard={op:"cut",node:o.node}}}),t.keybindings.registerBinding({command:"cut",key:"meta+x"}),t.commands.registerCommand({id:"copy",title:"Copy",when:o=>{if(!o.node)return!1;let i=t.getInput(o.path);return i&&i.selectionStart===i.selectionEnd?!0:(t.clipboard=void 0,!1)},action:o=>{t.clipboard={op:"copy",node:o.node}}}),t.keybindings.registerBinding({command:"copy",key:"meta+c"}),t.commands.registerCommand({id:"copy-reference",title:"Copy as Reference",when:o=>{if(!o.node)return!1;let i=t.getInput(o.path);return i&&i.selectionStart===i.selectionEnd?!0:(t.clipboard=void 0,!1)},action:o=>{t.clipboard={op:"copyref",node:o.node}}}),t.keybindings.registerBinding({command:"copy-reference",key:"shift+ctrl+c"}),t.commands.registerCommand({id:"paste",title:"Paste",when:o=>!!t.clipboard,action:o=>{if(!o.node||o.path.previous&&O(o.path.previous))return;switch(t.clipboard.op){case"copy":t.clipboard.node=t.clipboard.node.duplicate();break;case"copyref":let s=t.workspace.new("");s.refTo=t.clipboard.node,t.clipboard.node=s;break}t.clipboard.node.raw.Rel==="Fields"?(t.clipboard.node.raw.Parent=o.node.parent.id,o.node.parent.addLinked("Fields",t.clipboard.node)):(t.clipboard.node.parent=o.node.parent,t.clipboard.node.siblingIndex=o.node.siblingIndex),m.redraw.sync();let i=o.path.clone();i.pop(),t.focus(i.append(t.clipboard.node))}}),t.keybindings.registerBinding({command:"paste",key:"meta+v"}),t.commands.registerCommand({id:"view-list",title:"View as List",action:o=>{o.node&&o.node.setAttr("view","list")}}),t.commands.registerCommand({id:"view-table",title:"View as Table",action:o=>{o.node&&(o.node.setAttr("view","table"),o.node.children.forEach(i=>{t.workspace.setExpanded(o.path.head,i,!1)}))}}),t.commands.registerCommand({id:"view-tabs",title:"View as Tabs",action:o=>{o.node&&o.node.setAttr("view","tabs")}}),t.commands.registerCommand({id:"add-page",title:"Add page",action:o=>{if(!o.node)return;let i=new P;o.node.addComponent(i)}}),t.commands.registerCommand({id:"remove-page",title:"Remove page",action:o=>{o.node&&o.node.removeComponent(P)}}),t.commands.registerCommand({id:"add-checkbox",title:"Add checkbox",action:o=>{if(!o.node)return;let i=new T;o.node.addComponent(i)}}),t.commands.registerCommand({id:"remove-checkbox",title:"Remove checkbox",action:o=>{o.node&&o.node.removeComponent(T)}}),t.commands.registerCommand({id:"create-field",title:"Create Field",action:o=>{if(!o.node||o.node.childCount>0||o.node.componentCount>0||o.path.previous&&O(o.path.previous))return;let i=o.path.clone();i.pop();let s=t.workspace.new(o.node.name,"");s.raw.Parent=o.node.parent.id;let l=new U;s.addComponent(l),o.node.parent.addLinked("Fields",s),i.push(s),o.node.destroy(),m.redraw.sync(),t.focus(i)}}),t.commands.registerCommand({id:"mark-done",title:"Mark done",action:o=>{if(o.node)if(o.node.hasComponent(T)){let i=o.node.getComponent(T);i.checked?o.node.removeComponent(T):(i.checked=!0,o.node.changed())}else{let i=new T;o.node.addComponent(i)}}}),t.keybindings.registerBinding({command:"mark-done",key:"meta+enter"}),t.commands.registerCommand({id:"expand",title:"Expand",action:o=>{o.node&&(t.workspace.setExpanded(o.path.head,o.node,!0),m.redraw())}}),t.keybindings.registerBinding({command:"expand",key:"meta+arrowdown"}),t.commands.registerCommand({id:"collapse",title:"Collapse",action:o=>{o.node&&(t.workspace.setExpanded(o.path.head,o.node,!1),m.redraw())}}),t.keybindings.registerBinding({command:"collapse",key:"meta+arrowup"}),t.commands.registerCommand({id:"indent",title:"Indent",action:o=>{if(!o.node||o.node.raw.Rel==="Fields")return;let i=o.node,s=o.path.clone(),l=i.prevSibling;for(;l&&O(l);)if(l=l.prevSibling,!l)return;l!==null&&(s.pop(),s.push(l),i.parent=l,s.push(i),t.workspace.setExpanded(o.path.head,l,!0),m.redraw.sync(),t.focus(s))}}),t.keybindings.registerBinding({command:"indent",key:"tab"}),t.commands.registerCommand({id:"outdent",title:"Outdent",action:o=>{if(!o.node||o.node.raw.Rel==="Fields"||o.path.previous&&O(o.path.previous))return;let i=o.node,s=o.path.previous,l=o.path.clone();s!==null&&s.id!=="@root"&&s.id!==t.workspace.lastOpenedID&&(l.pop(),l.pop(),i.parent=s.parent,l.push(i),i.siblingIndex=s.siblingIndex+1,s.childCount===0&&s.getLinked("Fields").length===0&&t.workspace.setExpanded(o.path.head,s,!1),m.redraw.sync(),t.focus(l))}}),t.keybindings.registerBinding({command:"outdent",key:"shift+tab"}),t.commands.registerCommand({id:"move-up",title:"Move Up",action:o=>{if(!o.node)return;let i=o.node,s=i.parent;if(s!==null&&s.id!=="@root"){let l=s.childCount;if(i.siblingIndex===0){if(!s.prevSibling)return;let d=o.path.clone();d.pop(),d.pop();let c=s.prevSibling;for(;c&&O(c);)if(c=c.prevSibling,!c)return;d.push(c),d.push(i),i.parent=c,i.siblingIndex=c.childCount-1,t.workspace.setExpanded(o.path.head,c,!0),m.redraw.sync(),t.focus(d)}else{if(l===1)return;i.siblingIndex=i.siblingIndex-1,m.redraw.sync()}}}}),t.keybindings.registerBinding({command:"move-up",key:"shift+meta+arrowup"}),t.commands.registerCommand({id:"move-down",title:"Move Down",action:o=>{if(!o.node)return;let i=o.node,s=i.parent;if(s!==null&&s.id!=="@root"){let l=s.childCount;if(i.siblingIndex===l-1){if(!s.nextSibling)return;let d=o.path.clone();d.pop(),d.pop();let c=s.nextSibling;for(;c&&O(c);)if(c=c.nextSibling,!c)return;d.push(c),d.push(i),i.parent=c,i.siblingIndex=0,t.workspace.setExpanded(o.path.head,c,!0),m.redraw.sync(),t.focus(d)}else{if(l===1)return;i.siblingIndex=i.siblingIndex+1,m.redraw.sync()}}}}),t.keybindings.registerBinding({command:"move-down",key:"shift+meta+arrowdown"}),t.commands.registerCommand({id:"insert-child",title:"Insert Child",action:(o,i="",s)=>{if(!o.node||O(o.node))return;let l=t.workspace.new(i);l.parent=o.node,s!==void 0&&(l.siblingIndex=s),t.workspace.setExpanded(o.path.head,o.node,!0),m.redraw.sync(),t.focus(o.path.append(l),i.length)}}),t.commands.registerCommand({id:"insert-before",title:"Insert Before",action:o=>{if(!o.node||o.path.previous&&O(o.path.previous))return;let i=t.workspace.new("");i.parent=o.node.parent,i.siblingIndex=o.node.siblingIndex,m.redraw.sync();let s=o.path.clone();s.pop(),t.focus(s.append(i))}}),t.commands.registerCommand({id:"insert",title:"Insert Node",action:(o,i="")=>{if(!o.node||o.path.previous&&O(o.path.previous))return;let s=t.workspace.new(i);s.parent=o.node.parent,s.siblingIndex=o.node.siblingIndex+1,m.redraw.sync();let l=o.path.clone();l.pop(),t.focus(l.append(s))}}),t.keybindings.registerBinding({command:"insert",key:"shift+enter"}),t.commands.registerCommand({id:"create-reference",title:"Create Reference",action:o=>{if(!o.node||o.path.previous&&O(o.path.previous))return;let i=t.workspace.new("");i.parent=o.node.parent,i.siblingIndex=o.node.siblingIndex+1,i.refTo=o.node,m.redraw.sync();let s=o.path.clone();s.pop(),t.focus(s.append(i))}}),t.commands.registerCommand({id:"delete",title:"Delete node",action:o=>{if(!o.node||o.node.id.startsWith("@")||o.path.previous&&O(o.path.previous))return;let i=t.workspace.findAbove(o.path);if(o.node.destroy(),m.redraw.sync(),i){let s=0;o.event&&o.event.key==="Backspace"&&(i.node.value?s=i.node.value.length:s=i.node.name.length),i.node.childCount===0&&t.workspace.setExpanded(o.path.head,i.node,!1),t.focus(i,s)}}}),t.keybindings.registerBinding({command:"delete",key:"shift+meta+backspace"}),t.commands.registerCommand({id:"prev",action:o=>{if(!o.node)return;let i=t.workspace.findAbove(o.path);i&&t.focus(i)}}),t.keybindings.registerBinding({command:"prev",key:"arrowup"}),t.commands.registerCommand({id:"next",action:o=>{if(!o.node)return;let i=t.workspace.findBelow(o.path);i&&t.focus(i)}}),t.keybindings.registerBinding({command:"next",key:"arrowdown"}),t.commands.registerCommand({id:"pick-command",hidden:!0,action:o=>{let i=o.node,s=o.path,l=!1;i||(i=o.path.head,s=new F(o.path.head,o.path.name),l=!0);let d=t.getInput(s),c=d.getBoundingClientRect(),p=r.body.scrollLeft+c.x+d.selectionStart*10+20,f=r.body.scrollTop+c.y-8;l&&(p=r.body.scrollLeft+c.x,f=r.body.scrollTop+c.y+c.height),t.showPalette(p,f,t.newContext({node:i}))}}),t.keybindings.registerBinding({command:"pick-command",key:"meta+k"}),t.commands.registerCommand({id:"new-panel",title:"Open in New Panel",action:o=>{o.node&&(t.openNewPanel(o.node),m.redraw())}}),t.commands.registerCommand({id:"close-panel",title:"Close Panel",action:(o,i)=>{t.closePanel(i||o.path),t.context.path=t.mainPanel,m.redraw()}}),t.commands.registerCommand({id:"zoom",title:"Open",action:o=>{t.workspace.lastOpenedID=o.node.id,t.workspace.save(),t.context.path=o.path.append(o.node),t.panels[0]=t.context.path,m.redraw()}}),t.commands.registerCommand({id:"generate-random",title:"Generate Random Children",action:o=>{o.node&&[...Array(100)].forEach(()=>{let i=t.workspace.new(nt(8));i.parent=o.node})}}),t.menus.registerMenu("node",[{command:"zoom"},{command:"new-panel"},{command:"cut"},{command:"copy"},{command:"paste"},{command:"indent"},{command:"outdent"},{command:"move-up"},{command:"move-down"},{command:"delete"}]),t.menus.registerMenu("settings",[{title:()=>`${t.backend.auth?.currentUser()?.userID()} @ GitHub`,disabled:!0,when:()=>t.authenticated()},{title:()=>"Login with GitHub",when:()=>!t.authenticated(),onclick:()=>{localStorage.getItem("github")?t.backend.auth.login():t.showNotice("github",()=>{t.backend.auth.login()})}},{title:()=>"Reset Demo",when:()=>!t.authenticated(),onclick:()=>{localStorage.clear(),location.reload()}},{title:()=>"Settings",onclick:()=>t.showSettings()},{title:()=>"Documentation",onclick:()=>window.open("https://treehouse.sh/docs/user","_blank")},{title:()=>"Submit Issue",onclick:()=>window.open("https://github.com/treehousedev/treehouse/issues","_blank")},{title:()=>"Logout",when:()=>t.authenticated(),onclick:()=>t.backend.auth.logout()}]),r.addEventListener("keydown",o=>{let i=t.keybindings.evaluateEvent(o);if(i&&t.canExecuteCommand(i.command,t.context)){t.executeCommand(i.command,t.context),o.stopPropagation(),o.preventDefault();return}}),m.mount(e,{view:()=>m(Oe,{workbench:t})})}a(Go,"setup");function nt(r=10){let e=a((o,i)=>Math.round(Math.random()*(i-o)+o),"random"),n=a(()=>{let o=["got","ability","shop","recall","fruit","easy","dirty","giant","shaking","ground","weather","lesson","almost","square","forward","bend","cold","broken","distant","adjective"];return o[e(0,o.length-1)]},"word");return a(o=>[...Array(o)].map((i,s)=>n()).join(" ").trim(),"words")(e(2,r))}a(nt,"generateName");export{_ as BrowserBackend,ce as GitHubBackend,oe as SearchIndex_MiniSearch,Go as setup};
//# sourceMappingURL=treehouse.min.js.map
